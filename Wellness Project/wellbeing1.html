<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wellbeing Tracker - MindSync</title>
    <style>
        /* Existing CSS unchanged, only relevant snippets shown for brevity */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
        }
        .activity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 20px; }
        .activity-card {
            background-size: cover;
            background-position: center;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .activity-card:hover { transform: scale(1.05); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; padding: 20px; }
        .day { background: #e0e0e0; padding: 10px; text-align: center; border-radius: 5px; }
        .stars { color: gold; }
        @media (max-width: 600px) { .activity-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header style="background: linear-gradient(135deg, #74ebd5, #acb6e5); padding: 20px; text-align: center; color: white;">
        <h1>Wellbeing Tracker</h1>
    </header>
    <main>
        <section class="activity-grid">
            <div class="activity-card" style="background-image: url('https://images.pexels.com/photos/904616/pexels-photo-904616.jpeg');" onclick="openGoalModal('sleep')">Sleep</div>
            <div class="activity-card" style="background-image: url('https://images.pexels.com/photos/1640777/pexels-photo-1640777.jpeg');" onclick="openGoalModal('diet')">Diet</div>
            <div class="activity-card" style="background-image: url('https://images.pexels.com/photos/2294361/pexels-photo-2294361.jpeg');" onclick="openGoalModal('exercise')">Exercise</div>
            <div class="activity-card" style="background-image: url('https://images.pexels.com/photos/590516/pexels-photo-590516.jpeg');" onclick="openGoalModal('journaling')">Journaling</div>
        </section>
        <section class="calendar" id="calendar"></section>
    </main>

    <!-- Goal Setting Modal -->
    <div class="modal" id="goalModal">
        <div class="modal-content">
            <h2 id="goalModalTitle"></h2>
            <form id="goalForm">
                <label id="goalLabel"></label>
                <input type="number" id="goalInput" min="0" step="any">
                <button type="submit">Set Goal</button>
                <button type="button" onclick="closeModal('goalModal')">Close</button>
            </form>
        </div>
    </div>

    <!-- Progress Tracking Modal -->
    <div class="modal" id="progressModal">
        <div class="modal-content">
            <h2 id="progressModalTitle"></h2>
            <form id="progressForm">
                <label id="progressLabel"></label>
                <input type="number" id="progressInput" min="0" step="any">
                <label id="journalLabel" style="display: none;">Journal Notes</label>
                <textarea id="journalInput" style="display: none;"></textarea>
                <button type="submit">Log Progress</button>
                <button type="button" onclick="closeModal('progressModal')">Close</button>
            </form>
        </div>
    </div>

    <script>
        const backendUrl = 'http://localhost:5000';
        const userId = localStorage.getItem('userId');
        let currentActivity;

        function openGoalModal(activity) {
            currentActivity = activity;
            const modal = document.getElementById('goalModal');
            const title = document.getElementById('goalModalTitle');
            const label = document.getElementById('goalLabel');
            title.textContent = `Set ${activity.charAt(0).toUpperCase() + activity.slice(1)} Goal`;
            label.textContent = activity === 'sleep' ? 'Hours per night' : activity === 'diet' ? 'Calories per day' : activity === 'exercise' ? 'Minutes per day' : 'Notes';
            modal.style.display = 'flex';
        }

        function openProgressModal(activity) {
            currentActivity = activity;
            const modal = document.getElementById('progressModal');
            const title = document.getElementById('progressModalTitle');
            const label = document.getElementById('progressLabel');
            const journalLabel = document.getElementById('journalLabel');
            const journalInput = document.getElementById('journalInput');
            title.textContent = `Log ${activity.charAt(0).toUpperCase() + activity.slice(1)} Progress`;
            label.textContent = activity === 'sleep' ? 'Hours slept' : activity === 'diet' ? 'Calories consumed' : activity === 'exercise' ? 'Minutes exercised' : 'Notes';
            journalLabel.style.display = activity === 'journaling' ? 'block' : 'none';
            journalInput.style.display = activity === 'journaling' ? 'block' : 'none';
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.getElementById('goalInput').value = '';
            document.getElementById('progressInput').value = '';
            document.getElementById('journalInput').value = '';
        }

        document.getElementById('goalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const value = document.getElementById('goalInput').value;
            if (!value && currentActivity !== 'journaling') return;
            const date = new Date().toISOString().split('T')[0];
            const body = { userId, date };
            if (currentActivity === 'sleep') body.sleepHours = parseFloat(value);
            if (currentActivity === 'diet') body.calories = parseFloat(value);
            if (currentActivity === 'exercise') body.exerciseMinutes = parseFloat(value);
            if (currentActivity === 'journaling') body.journalNotes = value;

            try {
                const response = await fetch(`${backendUrl}/api/goals`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await response.json();
                if (response.ok) {
                    alert('Goal saved!');
                    closeModal('goalModal');
                    renderCalendar();
                } else {
                    alert(data.message || 'Error saving goal');
                }
            } catch (err) {
                alert('Error connecting to server');
            }
        });

        document.getElementById('progressForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const value = document.getElementById('progressInput').value;
            const journal = document.getElementById('journalInput').value;
            const date = new Date().toISOString().split('T')[0];
            const body = { userId, date };
            if (currentActivity === 'sleep') body.sleepHours = parseFloat(value);
            if (currentActivity === 'diet') body.calories = parseFloat(value);
            if (currentActivity === 'exercise') body.exerciseMinutes = parseFloat(value);
            if (currentActivity === 'journaling') body.journalNotes = journal;

            try {
                const response = await fetch(`${backendUrl}/api/goals`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await response.json();
                if (response.ok) {
                    alert('Progress logged!');
                    closeModal('progressModal');
                    renderCalendar();
                } else {
                    alert(data.message || 'Error logging progress');
                }
            } catch (err) {
                alert('Error connecting to server');
            }
        });

        async function renderCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            const date = new Date(2025, 3, 1); // April 2025
            const daysInMonth = 30;
            for (let i = 1; i <= daysInMonth; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                dayDiv.textContent = i;
                const formattedDate = `2025-04-${i.toString().padStart(2, '0')}`;
                try {
                    const response = await fetch(`${backendUrl}/api/goals/${userId}/${formattedDate}`);
                    const goal = await response.json();
                    if (goal && Object.keys(goal).length) {
                        const stars = calculateStars(goal);
                        dayDiv.innerHTML += `<div class="stars">${'â˜…'.repeat(stars)}</div>`;
                    }
                } catch (err) {
                    console.error('Error fetching goal:', err);
                }
                calendar.appendChild(dayDiv);
            }
        }

        function calculateStars(goal) {
            let total = 0;
            if (goal.sleepHours) total += goal.sleepHours / 8;
            if (goal.calories) total += goal.calories / 2000;
            if (goal.exerciseMinutes) total += goal.exerciseMinutes / 30;
            const avg = total / (goal.journalNotes ? 4 : 3);
            return Math.round(avg * 5);
        }

        // Initialize
        if (!userId) {
            alert('Please log in first');
            window.location.href = 'index.html';
        } else {
            renderCalendar();
            // Add click listeners for progress
            document.querySelectorAll('.activity-card').forEach(card => {
                card.addEventListener('click', () => openProgressModal(card.textContent.toLowerCase()));
            });
        }
    </script>
</body>
</html>